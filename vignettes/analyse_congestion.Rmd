---
title: "Untitled"
author: "YM"
date: "11/01/2022"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(datatable.print.class = TRUE)
options(bitmapType='cairo')
```

```{r setup}
library(congestion)
library(xtradata)
library(sf)
library(ggplot2)
library(data.table)
library(dplyr)
library(lubridate)
library(ggtext)
library(ggforce)
library(scales)
library(showtext)
library(ggrepel)
library(patchwork)
```

# Time Series du niveau de congestion moyen

```{r}
congestion_from_sept2019_dt <- congestion_from_sept2019_dt %>% 
  .[, time := lubridate::as_datetime(time, tz = "Europe/Paris")] %>% 
  .[, date := lubridate::as_date(time)] %>% 
  .[, hour := data.table::hour(time)] %>% 
  .[, day := data.table::wday(time)] %>% 
  .[, HPM := hour %in% 7:9] %>% 
  .[, HPS := hour %in% 17:19] %>% 
  .[, JO := day %in% 2:6] %>% 
  .[scores_horaires_ponderes == 0, scores_horaires_ponderes := NA]



congestion_journaliere <- copy(congestion_from_sept2019_dt) %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]

```

```{r}
theme_macarons <- function(my_font) {
  # inspiré du style macarons de echarts
  # https://echarts.apache.org/en/theme-builder.html
  
  bg_color <- "white"
  
  font_add_google(name = my_font, family = my_font)
  showtext_auto()
  
  title_color <- "#008acd"
  subtitle_color <- "#aaaaaa"
  axis_tick_color <- rgb(51, 51, 51, maxColorValue = 255)
  axis_text_color <- axis_tick_color
  
  # 
  # title_color <- "#ffffff"
  # subtitle_color <- "#dddddd"
  # axis_tick_color <- subtitle_color
  # axis_text_color <- subtitle_color
  
  theme(text = element_text(family = my_font),
        axis.title = element_blank(),
        axis.text = element_text(color = axis_text_color),
        axis.text.x = element_text(size = 11),
        axis.text.y = element_text(size = 11),
        axis.ticks = element_line(color = subtitle_color, size = .5),
        axis.ticks.length.x = unit(.7, "lines"),
        axis.ticks.length.y = unit(.7, "lines"),
        panel.grid = element_blank(),
        plot.margin = margin(20, 20, 20, 20),
        plot.background = element_rect(fill = bg_color, color =  bg_color),
        panel.background = element_rect(fill = bg_color, color =  bg_color),
        plot.title = element_text(color = title_color, size = 18, family = my_font),
        plot.subtitle = element_markdown(color = subtitle_color, size = 13),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.position = "none")
  
}

pal <- c("#2ec7c9",
         "#b6a2de",
         "#5ab1ef",
         "#ffb980",
         "#d87a80",
         "#8d98b3",
         "#e5cf0d",
         "#97b552",
         "#95706d",
         "#dc69aa",
         "#07a2a4",
         "#9a7fd1",
         "#588dd5",
         "#f5994e",
         "#c05050",
         "#59678c",
         "#c9ab00",
         "#7eb00a",
         "#6f5553",
         "#c14089")
```

```{r}

# inspiré du style macarons de echarts
# https://echarts.apache.org/en/theme-builder.html

confinements <- data.frame(
  deb = c(as.Date("2020-03-17"), as.Date("2020-10-30"), as.Date("2021-04-03")),
  fin = c(as.Date("2020-05-10"), as.Date("2020-12-14"), as.Date("2021-05-03")),
  label = c("Confinement", "Confinement", "Confinement")
)

mini <- min(congestion_journaliere$score)
maxi <- max(congestion_journaliere$score)

my_font <- "Playfair Display"

plot_journalier <- ggplot(congestion_journaliere, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (Journée complète)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +
  
  theme_macarons(my_font = my_font) +
  
  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = mini, yend = maxi,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxi, label = label), angle = -90, hjust = 0,
                fill = NA, label.color = NA, family = my_font) +
  coord_cartesian( 
    ylim = c(mini,maxi)
  ) +
  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxi, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_journalier

```


# HPM

```{r}
congestion_HPM <- copy(congestion_from_sept2019_dt) %>% 
  .[HPM == TRUE] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]
```


```{r}

mini <- min(congestion_HPM$score)
maxi <- max(congestion_HPM$score)

plot_HPM <- ggplot(congestion_HPM, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (HPM)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +

     theme_macarons(my_font = my_font) +

  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = mini, yend = maxi,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxi, label = label), angle = -90, hjust = 0,
                fill = NA, label.color = NA, family = "Playfair Display") +
  coord_cartesian( 
    ylim = c(mini,maxi)
  ) +  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxi, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_HPM
```


# HPS

```{r}
congestion_HPS <- copy(congestion_from_sept2019_dt) %>% 
  .[HPS == TRUE] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]
```


```{r}

mini <- min(congestion_HPS$score)
maxi <- max(congestion_HPS$score)

plot_HPS <- ggplot(congestion_HPS, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (HPS)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +
 
   theme_macarons(my_font = my_font) +
  
  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = mini, yend = maxi,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxi, label = label), angle = -90, hjust = 0,
                fill = NA, label.color = NA, family = "Playfair Display") +
  coord_cartesian( 
    ylim = c(mini,maxi)
  ) +  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxi, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_HPS
```

# faire un seul graphe

```{r}
plot_journalier / (plot_HPM | plot_HPS)
```
