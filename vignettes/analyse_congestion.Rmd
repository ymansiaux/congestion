---
title: "Untitled"
author: "YM"
date: "11/01/2022"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(datatable.print.class = TRUE)
options(bitmapType='cairo')
```

```{r setup}
library(congestion)
library(xtradata)
library(sf)
library(ggplot2)
library(data.table)
library(dplyr)
library(lubridate)
library(ggtext)
library(ggforce)
library(scales)
library(showtext)
library(ggrepel)
library(patchwork)
```

# Time Series du niveau de congestion moyen

```{r}
congestion_from_sept2019_dt <- congestion_from_sept2019_dt %>% 
  .[scores_horaires_ponderes >3, scores_horaires_ponderes := 3] %>% 
  .[, time := lubridate::as_datetime(time, tz = "Europe/Paris")] %>% 
  .[, date := lubridate::as_date(time)] %>% 
  .[, hour := data.table::hour(time)] %>% 
  .[, day := data.table::wday(time)] %>% 
  .[, HPM := hour %in% 7:9] %>% 
  .[, HPS := hour %in% 17:19] %>% 
  .[, JO := day %in% 2:6] %>% 
  .[scores_horaires_ponderes == 0, scores_horaires_ponderes := NA]

congestion_journaliere <- copy(congestion_from_sept2019_dt) %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]

```

```{r}
theme_macarons <- function(my_font) {
  # inspiré du style macarons de echarts
  # https://echarts.apache.org/en/theme-builder.html
  
  bg_color <- "white"
  
  font_add_google(name = my_font, family = my_font)
  showtext_auto()
  
  title_color <- "#008acd"
  subtitle_color <- "#aaaaaa"
  axis_tick_color <- rgb(51, 51, 51, maxColorValue = 255)
  axis_text_color <- axis_tick_color
  
  # 
  # title_color <- "#ffffff"
  # subtitle_color <- "#dddddd"
  # axis_tick_color <- subtitle_color
  # axis_text_color <- subtitle_color
  
  theme(text = element_text(family = my_font),
        axis.title = element_blank(),
        axis.text = element_text(color = axis_text_color),
        axis.text.x = element_text(size = 11),
        axis.text.y = element_text(size = 11),
        axis.ticks = element_line(color = subtitle_color, size = .5),
        axis.ticks.length.x = unit(.7, "lines"),
        axis.ticks.length.y = unit(.7, "lines"),
        panel.grid = element_blank(),
        plot.margin = margin(20, 20, 20, 20),
        plot.background = element_rect(fill = bg_color, color =  bg_color),
        panel.background = element_rect(fill = bg_color, color =  bg_color),
        plot.title = element_text(color = title_color, size = 18, family = my_font),
        plot.subtitle = element_markdown(color = subtitle_color, size = 13),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.position = "none")
  
}

pal <- c("#2ec7c9",
         "#b6a2de",
         "#5ab1ef",
         "#ffb980",
         "#d87a80",
         "#8d98b3",
         "#e5cf0d",
         "#97b552",
         "#95706d",
         "#dc69aa",
         "#07a2a4",
         "#9a7fd1",
         "#588dd5",
         "#f5994e",
         "#c05050",
         "#59678c",
         "#c9ab00",
         "#7eb00a",
         "#6f5553",
         "#c14089")
```

```{r}
confinements <- data.frame(
  deb = c(as.Date("2020-03-17"), as.Date("2020-10-30"), as.Date("2021-04-03")),
  fin = c(as.Date("2020-05-10"), as.Date("2020-12-14"), as.Date("2021-05-03")),
  label = c("Confinement", "Confinement", "Confinement")
)
```


```{r}
miniJ <- min(congestion_journaliere$score)
maxiJ <- max(congestion_journaliere$score)

my_font <- "Playfair Display"

plot_journalier <- ggplot(congestion_journaliere, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (Journée complète)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +
  
  theme_macarons(my_font = my_font) +
  
  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = miniJ, ymax = maxiJ, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = miniJ, ymax = maxiJ, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = miniJ, ymax = maxiJ, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = miniJ, yend = maxiJ,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxiJ * .92, label = label), angle = -90, #hjust = 0,
                fill = NA, label.color = NA, family = my_font) +
  coord_cartesian( 
    ylim = c(miniJ,maxiJ)
  ) +
  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxiJ, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_journalier

```


# HPM

```{r}
congestion_HPM <- copy(congestion_from_sept2019_dt) %>% 
  .[HPM == TRUE] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]
```


```{r}

miniHPM <- min(congestion_HPM$score)
maxiHPM <- max(congestion_HPM$score)

plot_HPM <- ggplot(congestion_HPM, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (HPM)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +
  
  theme_macarons(my_font = my_font) +
  
  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = miniHPM, ymax = maxiHPM, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = miniHPM, ymax = maxiHPM, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = miniHPM, ymax = maxiHPM, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = miniHPM, yend = maxiHPM,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxiHPM * .92, label = label), angle = -90, #hjust = 0,
                fill = NA, label.color = NA, family = my_font) +
  coord_cartesian( 
    ylim = c(miniHPM,maxiHPM)
  ) +  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxiHPM, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_HPM
```


# HPS

```{r}
congestion_HPS <- copy(congestion_from_sept2019_dt) %>% 
  .[HPS == TRUE] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = date]
```


```{r}

miniHPS <- min(congestion_HPS$score)
maxiHPS <- max(congestion_HPS$score)

plot_HPS <- ggplot(congestion_HPS, aes(x = date, y = score)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Score de congestion",
       title = "Evolution score de congestion (HPS)",
       subtitle = "Fluide (1) - Dense (2) - Embouteillé (3)") +
  
  theme_macarons(my_font = my_font) +
  
  annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = miniHPS, ymax = maxiHPS, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = miniHPS, ymax = maxiHPS, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = miniHPS, ymax = maxiHPS, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = miniHPS, yend = maxiHPS,  color = pal[5]) +
  
  geom_richtext(data = confinements, mapping = aes(x = fin - ((fin-deb)/2), y = maxiHPS * .90, label = label), angle = -90, #hjust = 0,
                fill = NA, label.color = NA, family = "Playfair Display") +
  coord_cartesian( 
    ylim = c(miniHPS,maxiHPS)
  ) +  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxiHPS, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
plot_HPS
```

# faire un seul graphe

```{r}
plot_journalier / (plot_HPM | plot_HPS)
```

# Faire un écart à la référence : choisir une semaine de référence (1ere semaine de janvier 2020)

```{r}
congestion_journaliere_week_of_ref <- congestion_journaliere[date >= as_date("2020-01-06") & date < as_date("2020-01-13")] %>% 
  .[, day := data.table::wday(date)] 


congestion_journaliere_start_in_2020 <- congestion_journaliere[date >= as_date("2020-01-06")] %>% 
  .[, day := data.table::wday(date)] 

comparaison_journaliere_ref <- merge(congestion_journaliere_start_in_2020, congestion_journaliere_week_of_ref[, c("score", "day")], by = "day") %>% 
  .[, ecart_ref := score.x - score.y] %>% 
  .[order(date)]

```

```{r}
ggplot(comparaison_journaliere_ref, aes(x = date, y = ecart_ref)) +
  geom_line()
```




# Faire un graphe semblable avec les compteurs
# Voir les temps de parcours



# CARTO

## Dessin des tronçons

```{r}
troncons <- xtradata_requete_features(key = Sys.getenv("XTRADATA_KEY"), typename = "CI_TRAFI_L", backintime = "2020-03-20T08:00:00")

```


```{r}

theme_map <- function(my_font) {
  
  bg_color <- "white"
  font_add_google(name = my_font, family = my_font)
  showtext_auto()
  
  title_color <- "#008acd"
  subtitle_color <- "#aaaaaa"
  axis_tick_color <- rgb(51, 51, 51, maxColorValue = 255)
  axis_text_color <- axis_tick_color
  theme(text = element_text(family = my_font),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        plot.margin = margin(20, 20, 20, 20),
        plot.background = element_rect(fill = bg_color, color =  bg_color),
        panel.background = element_rect(fill = bg_color, color =  bg_color),
        plot.title = element_text(color = title_color, size = 18, family = my_font),
        plot.subtitle = element_markdown(color = subtitle_color, size = 13),
        plot.title.position = "plot",
        plot.caption.position = "plot")
}

bbox <- st_bbox(troncons)

ggplot(troncons) +
  geom_sf(aes(color = "red")) +
  coord_sf(xlim=c(bbox$xmin, bbox$xmax), ylim = c(bbox$ymin, bbox$ymax)) +
  theme_map(my_font = "Playfair Display")

```
## Carte moyenne journalière J ouvres 1 mois avant confinement 1 

```{r}

confinement1 <- confinements[1,]

congestion_1mois_avant_confinement <- copy(congestion_from_sept2019_dt) %>% 
  .[date >= add_with_rollback(confinement1$deb, -months(1)) & date < add_with_rollback(confinement1$deb, -months(1)+weeks(1))] %>% 
  .[JO == TRUE & hour %in% 7:20] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = gid]


congestion_pendant_confinement <- copy(congestion_from_sept2019_dt) %>% 
  .[date >= add_with_rollback(confinement1$deb, months(1)) & date < add_with_rollback(confinement1$deb, months(1)+weeks(1))] %>% 
  .[JO == TRUE & hour %in% 7:20] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = gid]

congestion_1mois_apres_confinement <- copy(congestion_from_sept2019_dt) %>% 
  .[date >= add_with_rollback(confinement1$fin, months(1)) & date < add_with_rollback(confinement1$fin, months(1)+weeks(1))] %>% 
  .[JO == TRUE & hour %in% 7:20] %>% 
  .[, .(score = mean(scores_horaires_ponderes, na.rm = TRUE)), by = gid]


```

```{r}
troncons_1mois_avant_confinement <- inner_join(troncons, congestion_1mois_avant_confinement, by = "gid" )
troncons_pendant_confinement <- inner_join(troncons, congestion_pendant_confinement, by = "gid" )
troncons_1mois_apres_confinement <- inner_join(troncons, congestion_1mois_apres_confinement, by = "gid" )
```


```{r}
crs <- st_crs(troncons)

eau <- xtradata_requete_features(key = Sys.getenv("XTRADATA_KEY"), typename = "to_hydro_s")
garonne <- dplyr::filter(eau, typea == "FLEUVE")
limites_communes <- xtradata_requete_features(key = Sys.getenv("XTRADATA_KEY"), typename = "to_liadm_l")
filaire <- xtradata_requete_features(key = Sys.getenv("XTRADATA_KEY"), typename = "fv_tronc_l")

```


```{r}

map_preconfinement <- ggplot() +
  
  geom_sf(data = troncons_1mois_avant_confinement, aes(color = score), lwd = 1.5) +
  
  scale_color_gradient2(midpoint = 2, low = "#2E7F18", mid = "yellow", high = "#C82538") +
  
  geom_sf(data = limites_communes, color = "black", fill = "white", alpha = .3) +
  
  geom_sf(data = garonne, fill = "#ccddef",  
          color = "#ccddef", alpha = .5)  +
  
  geom_sf(data = dplyr::filter(filaire, cat_dig %in% 1:4), color = "grey", alpha = .5) +
  
  theme_map(my_font = "Playfair Display")

```


```{r}
map_confinement <- ggplot() +
  
  geom_sf(data = troncons_pendant_confinement, aes(color = score), lwd = 1.5) +
  
  scale_color_gradient2(midpoint = 2, low = "#2E7F18", mid = "yellow", high = "#C82538") +
  
  geom_sf(data = limites_communes, color = "black", fill = "white", alpha = .3) +
  
  geom_sf(data = garonne, fill = "#ccddef",  
          color = "#ccddef", alpha = .5)  +
  
  geom_sf(data = dplyr::filter(filaire, cat_dig %in% 1:4), color = "grey", alpha = .5) +
  
  theme_map(my_font = "Playfair Display")

```


```{r}
map_postconfinement <- ggplot() +
  
  geom_sf(data = troncons_1mois_apres_confinement, aes(color = score), lwd = 1.5) +
  
  scale_color_gradient2(midpoint = 2, low = "#2E7F18", mid = "yellow", high = "#C82538") +
  
  geom_sf(data = limites_communes, color = "black", fill = "white", alpha = .3) +
  
  geom_sf(data = garonne, fill = "#ccddef",  
          color = "#ccddef", alpha = .5)  +
  
  geom_sf(data = dplyr::filter(filaire, cat_dig %in% 1:4), color = "grey", alpha = .5) +
  
  theme_map(my_font = "Playfair Display")

```

## On va essayer de faire un gif des 3 cartes (et pour les 3 confinements)

```{r}
library(gganimate)

troncons_3 <- bind_rows(
  troncons_1mois_avant_confinement %>% mutate(periode = "1-preconfinement"),
  troncons_pendant_confinement %>% mutate(periode = "2-confinement"),
  troncons_1mois_apres_confinement %>% mutate(periode = "3-postconfinement")
)


p <- ggplot() +
  
  geom_sf(data = troncons_3, aes(color = score), lwd = 1.5) +
  
  scale_color_gradient2(midpoint = 2, low = "#2E7F18", mid = "yellow", high = "#C82538") +
  
  geom_sf(data = limites_communes, color = "black", fill = "white", alpha = .3) +
  
  geom_sf(data = garonne, fill = "#ccddef",  
          color = "#ccddef", alpha = .5)  +
  
  geom_sf(data = dplyr::filter(filaire, cat_dig %in% 1:4), color = "grey", alpha = .5) +
  
  theme_map(my_font = "Playfair Display")

anim <- p + 
  transition_states(periode,
                    transition_length = 2,
                    state_length = 1)

index_anim <- 
  animate(anim, nframes = 150, 
          fps = 5, detail = 5, end_pause = 25,
          width = 1150, height = 740, 
          device = "png", type = "cairo",  renderer = gifski_renderer())

anim_save(filename = here::here("2020_52_BigMacIndex.gif"), animation = index_anim)

# https://raw.githubusercontent.com/Z3tt/TidyTuesday/master/plots/2020_52/2020_52_BigMacIndex.gif
# https://github.com/z3tt/TidyTuesday/blob/master/R/2020_52_BigMacIndex.Rmd
# https://gganimate.com/articles/gganimate.html
```

# Analyse des capteurs

```{r}
# xtradata_requete_features(key = Sys.getenv("XTRADATA_KEY"), 
#                           typename = "PC_CAPTE_P",
#                           backintime = "2020-11-04T00:00:00"
# )
capteurs <- xtradata_requete_aggregate(key = Sys.getenv("XTRADATA_KEY"), 
                                       typename = "PC_CAPTE_P", 
                                       rangeStart = "2020-11-05", 
                                       rangeEnd = Sys.Date()-1,
                                       attributes = list("comptage_5m" = "sum"),
                                       group="time")

capteurs <- capteurs %>% 
  as.data.table() %>% 
  .[, time := lubridate::as_datetime(time, tz = "Europe/Paris")] %>% 
  .[, date := lubridate::as_date(time)] %>% 
  .[, hour := data.table::hour(time)] %>% 
  .[, day := data.table::wday(time)] %>% 
  .[, HPM := hour %in% 7:9] %>% 
  .[, HPS := hour %in% 17:19] %>% 
  .[, JO := day %in% 2:6]


```

```{r}
capteurs_sum_by_day <- capteurs %>% 
  .[, .(comptage_5m = sum(comptage_5m, na.rm = TRUE)), by = date]

mini <- min(capteurs_sum_by_day$comptage_5m)
maxi <- max(capteurs_sum_by_day$comptage_5m)

ggplot(capteurs_sum_by_day, aes(x = date, y = comptage_5m)) +
  geom_line(alpha = .6, color = pal[1]) +
  geom_smooth(method = "gam", se = FALSE, color = pal[3]) +
  labs(x = "Date", y = "Somme des comptages journaliers",
       title = "Evolution des comptages journaliers") +
  
  theme_macarons(my_font = my_font) +
  
  # annotate("rect", xmin = as.Date("2020-03-17"), xmax = as.Date("2020-05-10"), ymin = miniHPS, ymax = maxiHPS, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2020-10-30"), xmax = as.Date("2020-12-14"), ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("rect", xmin = as.Date("2021-04-03"), xmax = as.Date("2021-05-03"),  ymin = mini, ymax = maxi, alpha = .25, fill = pal[4]) +
  annotate("segment", x = (as.Date("2021-06-20")), xend = (as.Date("2021-06-20")),  y = mini, yend = maxi,  color = pal[5]) +
  
  geom_richtext(data = confinements[-1,], mapping = aes(x = fin - ((fin-deb)/2), y = maxi, label = label), angle = -90, hjust = 0,
                fill = NA, label.color = NA, family = "Playfair Display") +
  coord_cartesian( 
    ylim = c(mini,maxi)
  ) +  geom_richtext(data = tibble(label = "fin du couvre feu", x = as.Date("2021-06-20")+days(3)), mapping = aes(x = x, y = .99 * maxi, label = label), angle = 0, hjust = 0, fill = NA, label.color = NA, color = pal[5], family = my_font)
```

# Temps de parcours : étude d'un écart à la référence

```{r}
temps_parcours_geo <- read_sf("/data/donnees_geo/CI_TRAFI_L/temps_trajet.json")

# temps_parcours <- xtradata_requete_features(
#   key = Sys.getenv("XTRADATA_KEY"), 
#   typename = "CI_TPSTJ_A",
#   backintime = "2021-08-04T08:00:00"
# )

temps_parcours_stats <- xtradata_requete_aggregate(
  key = Sys.getenv("XTRADATA_KEY"), 
  typename = "CI_TPSTJ_A",
  rangeStart = "2021-08-05",
  rangeEnd = Sys.Date()-1,
  rangeStep = "hour",
  attributes = list("actuel"="average", "ref"="average")
)


temps_parcours_DT <- as.data.table(temps_parcours_stats) %>% 
  .[, time := as_datetime(time, tz = "Europe/Paris")] %>% 
  .[, ecart_actuel_ref := (100 * actuel / ref)]

temps_parcours_hourly <- copy(temps_parcours_DT) %>% 
  .[ecart_actuel_ref != Inf] %>% 
  .[, .(ecart_actuel_ref = mean(ecart_actuel_ref)), by = time]
```

```{r}
ggplot(temps_parcours_hourly[ecart_actuel_ref>1000, ecart_actuel_ref := 1000], aes(x = time, y = ecart_actuel_ref)) +
  geom_line()
```


